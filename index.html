<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="default-src 'self'; script-src 'self' 'unsafe-inline' https://script.google.com; connect-src 'self' https://script.google.com https://script.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://placehold.co;" http-equiv="Content-Security-Policy"/>
<title>Cascade Hideaway - Cleaning and Turn-over Report</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#22333B">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="CH Checklist">
<link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&amp;family=Cormorant+Garamond:wght@700&amp;family=Raleway:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
:root {
    --earthen-darkest: #0A0908;
    --earthen-slate: #22333B;
    --earthen-ivory: #EAE0D5;
    --earthen-gold: #C6AC8E;
    --earthen-mocha: #5E503F;
    --primary-green: var(--earthen-slate);
    --accent-gold: var(--earthen-gold);
    --light-gold-bg: var(--earthen-ivory);
    --background: var(--earthen-ivory);
    --surface: #FFFFFF;
    --text-primary: var(--earthen-darkest);
    --text-secondary: var(--earthen-mocha);
    --border: #DCD4CA;
    --success: #006B54;
    --error: #C1414D;
    --shadow: rgba(34, 51, 59, 0.12);
    --disinfect: #2563eb;
    --disinfect-bg: #dbeafe;
    --warning: #f59e0b;
    --font-size-base: clamp(1rem, 0.95rem + 0.25vw, 1.125rem);
    --font-size-h1: clamp(2.2rem, 1.5rem + 3.5vw, 3.2rem);
    --font-size-h2: clamp(2rem, 1.5rem + 2.5vw, 2.8rem);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
}

body {
    font-family: 'Raleway', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--background);
    color: var(--text-primary);
    line-height: 1.65;
    letter-spacing: 0.02em;
    -webkit-font-smoothing: antialiased;
    padding: 1rem;
    padding-bottom: 120px;
    position: relative;
}

body::after {
    content: 'CONFIDENTIAL';
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: clamp(4rem, 1rem + 20vw, 12rem);
    color: rgba(0, 0, 0, 0.04);
    font-weight: 700;
    z-index: -1;
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 10px;
}

.main-container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--surface);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 15px -3px var(--shadow), 0 4px 6px -2px var(--shadow);
    border: 1px solid var(--border);
}

.header {
    background: linear-gradient(135deg, var(--earthen-slate) 0%, var(--earthen-mocha) 100%);
    color: var(--surface);
    padding: 2.5rem 2rem;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: 'üåø';
    position: absolute;
    font-size: 120px;
    opacity: 0.08;
    top: -20px;
    right: -20px;
    transform: rotate(-15deg);
    animation: subtle-rotate 15s linear infinite;
}

.header h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: var(--font-size-h1);
    font-weight: 700;
    position: relative;
    margin-bottom: 0.25rem;
    background: linear-gradient(135deg, #FFFFFF 60%, #F5EFE6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-fill-color: transparent;
}

.header .subtitle {
    font-size: clamp(0.9rem, 0.8rem + 0.5vw, 1rem);
    color: var(--light-gold-bg);
    font-weight: 500;
    opacity: 0.95;
    font-family: 'Raleway', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-field-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.info-field label {
    font-size: 0.8em;
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.info-field input {
    width: 100%;
    padding: 0.85rem 1rem;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 1em;
    font-family: 'Raleway', sans-serif;
    background: #FDFDFD;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    font-weight: 500;
}

#cleanerName {
    font-size: 1.1em;
    font-family: 'Cormorant Garamond', serif;
    font-weight: 700;
    color: var(--primary-green);
}

.info-field input:focus {
    outline: none;
    border-color: var(--accent-gold);
    box-shadow: 0 0 0 4px rgba(198, 172, 142, 0.15);
    background: var(--surface);
}

.info-guides {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2.5rem;
    padding-top: 2.5rem;
    border-top: 1px solid var(--border);
}

.guide-card {
    background: #FFFFFF;
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid var(--border);
    border-left-width: 5px;
    transition: all 0.3s ease;
}
.guide-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.07);
}

.guide-card.kit { border-left-color: var(--primary-green); }
.guide-card.agents { border-left-color: var(--accent-gold); }

.guide-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}
.guide-card-header .icon { font-size: 1.5em; }
.guide-card-header h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.6em;
    color: var(--primary-green);
    margin: 0;
}

.guide-card p {
    font-size: clamp(0.88em, 0.85em + 0.15vw, 0.92em);
    line-height: 1.8;
    color: var(--text-secondary);
}
.guide-card .item { 
    margin-bottom: 0.5rem; 
    display: block; 
}
.guide-card .item strong { color: var(--text-primary); }

.navigation-tabs {
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1.5rem 0;
    gap: 0.5rem;
    scrollbar-width: none;
}
.navigation-tabs::-webkit-scrollbar { display: none; }

.nav-tab {
    padding: 0.85rem 1.25rem;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.9em;
    white-space: nowrap;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    border-radius: 8px 8px 0 0;
}
.nav-tab:hover {
    background: rgba(198, 172, 142, 0.10);
    color: var(--earthen-darkest);
}
.nav-tab.active {
    color: var(--earthen-darkest);
    border-bottom-color: var(--earthen-gold);
    background: rgba(198, 172, 142, 0.12);
}
.nav-tab.completed { color: var(--success); }
.nav-tab.weekly { background: rgba(147, 51, 234, 0.08); }
.nav-tab .icon { margin-right: 0.5rem; font-size: 1.1em; }

.card-container {
    position: relative;
    overflow: hidden;
    padding: 2.5rem;
    min-height: 500px; 
    touch-action: pan-y;
}

.card {
    top: 0; left: 0; width: 100%;
    opacity: 0; visibility: hidden; position: absolute;
    transform: scale(0.98) translateX(20px);
    transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.5s;
}

.card.active {
    opacity: 1; visibility: visible;
    transform: scale(1) translateX(0);
    position: relative;
}

.card h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: var(--font-size-h2);
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: var(--primary-green);
}

.section-description, .pro-tip {
    background: var(--light-gold-bg);
    padding: 1.25rem;
    margin-bottom: 1.75rem;
    border-radius: 12px;
    border-left: 4px solid var(--accent-gold);
    font-size: 0.95em;
    line-height: 1.65;
    letter-spacing: 0.02em;
}
.pro-tip { margin-top: 1.75rem; }

.pro-tip strong { color: var(--primary-green); font-weight: 700; }

.checklist-item {
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    transition: background 0.3s ease;
    position: relative;
}

.checklist-item:nth-child(even) {
    background: rgba(234, 224, 213, 0.15);
    border-radius: 8px;
    padding-left: 1rem;
    padding-right: 1rem;
}

.checklist-item:nth-child(odd) {
    background: rgba(255, 255, 255, 0.5);
}

.checklist-item:hover {
    transform: scale(1.01);
    box-shadow: 0 4px 15px var(--shadow);
    border-radius: 12px;
    background: rgba(198, 172, 142, 0.12);
    padding-left: 1.25rem;
    padding-right: 1.25rem;
}
.checklist-item:last-child { border-bottom: none; }

.checklist-item.disinfect {
    border-left: 3px solid var(--disinfect);
}

.checklist-item.disinfect .disinfect-badge {
    display: inline-block;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    font-size: 0.75em;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    margin-left: 0.5rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    vertical-align: middle;
}

.checklist-item.biweekly {
    background: linear-gradient(105deg, #fef9f3, #fef5e7) !important;
    border-left: 3px solid var(--warning);
}

.checklist-item.biweekly::before {
    content: 'üîπ';
    position: absolute;
    right: 10px;
    top: 10px;
    font-size: 1.3em;
    opacity: 0.6;
}

.checklist-item input[type="checkbox"] {
    -webkit-appearance: none; appearance: none;
    margin-top: 4px;
    width: 1.5em; height: 1.5em;
    border: 2.5px solid var(--border);
    border-radius: 6px;
    display: grid;
    place-content: center;
    flex-shrink: 0;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.checklist-item input[type="checkbox"]:hover { border-color: var(--accent-gold); transform: scale(1.05); }

.checklist-item input[type="checkbox"]::before {
    content: ""; width: 0.75em; height: 0.75em;
    transform: scale(0);
    transition: 180ms transform ease-in-out;
    box-shadow: inset 1em 1em var(--accent-gold);
    transform-origin: center;
    clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
}

.checklist-item input[type="checkbox"]:checked { background: var(--light-gold-bg); border-color: var(--accent-gold); }
.checklist-item input[type="checkbox"]:checked::before { transform: scale(1); }

.checklist-item label { flex: 1; cursor: pointer; font-weight: 600; transition: color 0.3s ease; font-size: 1.02em; }
.checklist-item.checked label { text-decoration: line-through; color: var(--text-secondary); opacity: 0.7; }

.item-detail {
    font-size: 0.9em; color: var(--text-secondary);
    margin-top: 0.35rem; padding-left: 0.5rem;
    font-weight: 400; line-height: 1.6;
}
.item-detail code {
    background-color: #f0f0f0; padding: 2px 6px;
    border-radius: 4px; font-family: monospace; font-size: 0.9em;
}

.scenario-box {
    background: linear-gradient(105deg, #fdfcf9, #fbf8f2);
    border: 1px solid var(--border);
    padding: 1.25rem;
    margin: 1.5rem 0;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}
.scenario-box .icon {
    font-size: 1.8rem;
    margin-top: 0.25rem;
}
.scenario-box .content .title {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 700;
    color: var(--primary-green);
    font-size: 1.2em;
    margin-bottom: 0.5rem;
}
.scenario-box .content .instruction {
    font-size: 0.95em;
    line-height: 1.6;
    color: var(--text-secondary);
}
.scenario-box .content .instruction strong.on {
    color: var(--success);
    font-weight: 700;
}
.scenario-box .content .instruction strong.off {
    color: var(--error);
    font-weight: 700;
}

.warning-box {
    background: #fef0f1;
    border: 1px solid #fde2e4;
    padding: 1.25rem;
    margin: 1.5rem 0;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}
.warning-box .icon {
    font-size: 1.8rem;
    margin-top: 0.25rem;
    color: var(--error);
}
.warning-box .content .title {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 700;
    color: var(--error);
    font-size: 1.2em;
    margin-bottom: 0.5rem;
}
.warning-box .content .instruction {
    font-size: 1em;
    line-height: 1.6;
    color: #8c2a32;
}

.photo-upload {
    border: 2px dashed var(--accent-gold); border-radius: 14px;
    padding: 1.75rem; margin: 1.5rem 0; text-align: center;
    background: rgba(180, 140, 79, 0.03); transition: all 0.3s ease;
}
.photo-upload:hover { border-color: var(--primary-green); background: rgba(198, 172, 142, 0.06); }
.photo-upload h4 { color: var(--primary-green); margin-bottom: 0.5rem; font-size: 1.15em; font-weight: 700; }
.photo-upload .photo-hint { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 1.25rem; }

input[type="file"] { display: none; }

.photo-btn-group {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.photo-upload-btn {
    background: var(--surface);
    color: var(--accent-gold);
    border: 2px solid var(--accent-gold);
    padding: 0.75rem 1.5rem;
    border-radius: 100px; cursor: pointer; display: inline-block; font-weight: 600;
    transition: all 0.3s ease;
}
.photo-upload-btn.primary {
    background: linear-gradient(135deg, var(--earthen-gold) 0%, #b39a7d 100%);
    color: var(--surface);
    border-color: var(--earthen-gold);
    box-shadow: 0 4px 12px var(--shadow);
}
.photo-upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--shadow);
}

.photo-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 1rem; margin-top: 1.25rem; }
.photo-preview-item {
    position: relative; border-radius: 10px; overflow: hidden;
    aspect-ratio: 1; border: 2px solid var(--border);
    transition: transform 0.2s ease;
}
.photo-preview-item:hover { transform: scale(1.03); }
.photo-preview-item img { width: 100%; height: 100%; object-fit: cover; }
.photo-preview-item .remove-photo {
    position: absolute; top: 6px; right: 6px;
    background: rgba(193, 65, 77, 0.9); color: white; border: none;
    border-radius: 50%; width: 28px; height: 28px;
    cursor: pointer; font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s ease;
}
.photo-preview-item .remove-photo:hover { background: var(--error); transform: scale(1.1); }

.navigation-footer {
    position: sticky; bottom: 0; left: 0; width: 100%;
    background: rgba(255, 255, 255, 0.88); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(220, 212, 202, 0.8);
    z-index: 100; padding: 1rem;
}
.navigation-controls {
    max-width: 900px; margin: 0 auto;
    display: flex; align-items: center; justify-content: space-between; gap: 1rem;
}

.progress-section { flex-grow: 1; }
.progress-label {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.5rem; font-size: 0.8em; font-weight: 600;
}
.progress-label .percentage { font-weight: 700; color: var(--primary-green); }
.progress-track { height: 8px; background: var(--border); border-radius: 8px; overflow: hidden; }
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--earthen-gold) 0%, #b39a7d 100%);
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px;
}

.nav-btn {
    background: linear-gradient(135deg, var(--earthen-slate) 0%, var(--earthen-mocha) 100%);
    color: var(--surface);
    border: none;
    padding: 0.9rem 2rem;
    font-size: 1em;
    border-radius: 100px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    font-family: 'Raleway', sans-serif;
    box-shadow: 0 4px 12px var(--shadow);
    flex-shrink: 0;
}
.nav-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--shadow);
}
.nav-btn:disabled { background: linear-gradient(135deg, #ccc 0%, #bbb 100%); cursor: not-allowed; opacity: 0.6; box-shadow: none; }
#submitBtn {
    background: linear-gradient(135deg, var(--earthen-gold) 0%, #b39a7d 100%);
}

.submission-status { padding: 0 2rem 1.5rem; text-align: center; }
.submit-message { padding: 1.25rem; border-radius: 12px; display: none; font-weight: 500; }
.submit-message.success { background: #e8f5f1; color: var(--success); border: 1px solid var(--success); display: block; }
.submit-message.error { background: #fef0f1; color: var(--error); border: 1px solid var(--error); display: block; }

.footer {
    background: var(--earthen-slate);
    color: rgba(255,255,255,0.85);
    text-align: center;
    padding: 2rem;
    font-size: 1em;
    word-wrap: break-word;
}

.security-footer {
    text-align: center;
    padding: 2rem 1rem;
    font-size: 0.8em;
    color: var(--text-secondary);
}
.security-footer p {
    margin: 0.5rem 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

.loading-spinner {
    border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid var(--surface);
    border-radius: 50%; width: 20px; height: 20px;
    animation: spin 1s linear infinite; display: inline-block;
    margin-left: 10px; vertical-align: middle;
}
@keyframes subtle-rotate {
    0% { transform: rotate(-15deg) scale(1); }
    50% { transform: rotate(5deg) scale(1.05); }
    100% { transform: rotate(-15deg) scale(1); }
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.modal {
    display: none; position: fixed; z-index: 1000;
    left: 0; top: 0; width: 100%; height: 100%;
    overflow: auto; background-color: rgba(0,0,0,0.65);
    align-items: center; justify-content: center;
}
.modal-content {
    background-color: var(--surface); margin: auto; padding: 2.5rem;
    border-radius: 16px; border: none; width: 90%; max-width: 500px;
    text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.modal-content h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.8em; color: var(--primary-green); margin-bottom: 1rem;
}
.modal-content p { margin-bottom: 1.75rem; color: var(--text-secondary); line-height: 1.6; }
.modal-buttons { display: flex; justify-content: center; gap: 1rem; }
.modal-btn { padding: 0.9rem 1.75rem; border-radius: 100px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
#modal-confirm-action, #error-modal-close {
    background: linear-gradient(135deg, var(--earthen-gold) 0%, #b39a7d 100%);
    color: white;
    box-shadow: 0 4px 12px var(--shadow);
}
#modal-confirm-action:hover, #error-modal-close:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--shadow);
}
#modal-go-back { background: #f5f5f5; color: var(--text-primary); }
#modal-go-back:hover { background: #e8e8e8; }
.modal-content ol { text-align: left; margin-left: 20px; margin-bottom: 1.5rem; }
.modal-content li { margin-bottom: 0.75rem; }
.modal-content code { background-color: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

textarea {
    width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--border);
    border-radius: 10px; font-size: 1em; font-family: 'Raleway', sans-serif;
    min-height: 120px; margin-top: 0.5rem; resize: vertical;
    transition: all 0.2s ease;
}
textarea:focus {
    outline: none;
    border-color: var(--accent-gold);
    box-shadow: 0 0 0 4px rgba(198, 172, 142, 0.15);
}

.navigation-footer { background: rgba(255, 255, 255, 0.88); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(220, 212, 202, 0.8); }
.save-draft-btn { background:#fff; border:1px solid var(--border); border-radius:50%; width:44px; height:44px; font-size:1.25rem; cursor:pointer; box-shadow:0 2px 8px var(--shadow); display:flex; align-items:center; justify-content:center; transition:all .3s ease; position:relative; }
.save-draft-btn:hover { transform: translateY(-2px); box-shadow:0 4px 12px var(--shadow); }
.save-draft-btn .save-draft-tooltip { position:absolute; bottom:110%; left:50%; transform:translateX(-50%); background:var(--earthen-slate); color:#fff; padding:4px 10px; border-radius:6px; font-size:.8em; font-weight:600; opacity:0; visibility:hidden; transition:opacity .3s ease, visibility .3s ease; white-space:nowrap; }
.save-draft-btn.saved .save-draft-tooltip { opacity:1; visibility:visible; }

@media screen and (max-width: 768px) {
    body {
        padding: 0.5rem;
        padding-bottom: 120px;
    }
    .main-container { border-radius: 15px; }
    .header h1 { font-size: var(--font-size-h1); }
    .card-container { padding: 1.5rem; }
    .navigation-tabs { padding: 0.75rem 1rem 0; }
    .nav-tab .label { display: none; }
}
@media screen and (max-width: 480px) {
    .nav-btn { padding: 0.8rem 1.2rem; font-size: 0.9em;}
}

/* === Inventory Modal Enhancements === */
.inv-scroll{max-height:55vh; overflow:auto; border:1px solid var(--border); border-radius:12px; margin:1rem 0;}
.inv-table{width:100%; border-collapse:collapse; font-size:0.95em;}
.inv-table thead th{position:sticky; top:0; background:#faf8f4; border-bottom:1px solid var(--border); padding:0.75rem; text-align:left;}
.inv-table td{padding:0.55rem 0.6rem; border-bottom:1px solid #eee; vertical-align:middle;}
.inv-table td small{color:var(--text-secondary); font-weight:600;}
.inv-qty{width:90px; padding:0.4rem 0.5rem; border:1px solid var(--border); border-radius:8px; font-weight:600;}
.inv-unit{opacity:0.8; font-size:0.9em;}
.inv-new{font-weight:700; color:var(--primary-green);}
#inventoryModal .modal-content{max-width:760px; text-align:left;}
#invError{background:#fef0f1; border:1px solid #fde2e4; padding:0.75rem 1rem; border-radius:10px; display:none;}
#invLastUpdated{margin-left:8px; font-size:0.9em; color:var(--text-secondary);}
</style>
</head>
<body>
<div class="main-container">
<header class="header">
<h1>CASCADE HIDEAWAY</h1>
<p class="subtitle">Cleaning and Turn-over Report</p>
</header>
<form id="cleaningForm">
<div class="navigation-tabs"></div>
<div class="card-container"></div>
<div class="submission-status">
<div class="submit-message" id="submitMessage"></div>
</div>
</form>
<footer class="footer">
            ‚ú® Calm ‚Ä¢ Clean ‚Ä¢ Consistent ‚Äî Every Stay ‚ú®
        </footer>
</div>
<div class="security-footer">
<p>¬© 2025 Cascade Hideaway. All Rights Reserved.</p>
<p>This document is confidential and proprietary. For authorized use only. Unauthorized reproduction, distribution, or commercial use is strictly prohibited.</p>
</div>
<div class="navigation-footer">
<div class="navigation-controls">
<button class="save-draft-btn" id="saveDraftBtn" title="Save Draft" type="button">üíæ<span class="save-draft-tooltip">Saved!</span></button>
<button class="nav-btn" id="prevBtn" type="button">‚Üê Previous</button>
<div class="progress-section">
<div class="progress-label">
<span>Progress</span>
<span class="percentage">0%</span>
</div>
<div class="progress-track">
<div class="progress-fill" style="width: 0%"></div>
</div>
</div>
<button class="nav-btn" id="nextBtn" type="button">Next ‚Üí</button>
</div>
</div>
<div class="modal" id="submissionModal">
<div class="modal-content">
<h3 id="modal-title">‚ö†Ô∏è Incomplete Items</h3>
<p id="modal-message">Some items are unchecked. Continue anyway?</p>
<div class="modal-buttons">
<button class="modal-btn" id="modal-go-back" type="button">Go Back &amp; Review</button>
<button class="modal-btn" id="modal-confirm-action" type="button">Continue</button>
</div>
</div>
</div>
<div class="modal" id="errorModal">
<div class="modal-content">
<h3 id="error-modal-title">‚ùå Script Configuration Error</h3>
<div id="error-modal-message" style="text-align: left;">
<p>The deployed Google Apps Script is not configured correctly. Please follow these steps carefully:</p>
<ol>
<li>Go to your Google Sheet and open the script editor via <strong>Extensions &gt; Apps Script</strong>.</li>
<li>In the script, find the line that says:<br/><code>const DRIVE_FOLDER_ID = '...';</code></li>
<li>Make sure your actual Google Drive Folder ID is pasted between the quotes.</li>
<li><strong>This is the most important step:</strong> You must publish the changes. Click the blue <strong>Deploy</strong> button, then select <strong>Manage deployments</strong>.</li>
<li>Select your active deployment, click the <strong>Edit</strong> (pencil) icon, change the version to <strong>"New version"</strong>, and click <strong>Deploy</strong>.</li>
</ol>
<p>If you create a "New deployment" instead of managing the existing one, you will get a <strong>new URL</strong> that you must paste back into this HTML file.</p>
</div>
<div class="modal-buttons">
<button class="modal-btn" id="error-modal-close" type="button">OK</button>
</div>
</div>
</div>

<script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxrhdpc-kFMKF7PLq46IPH6fPLLDeod-aHbb9Yk8qfJ3gsKqixBRY3XfpeNj4WMFpqA/exec"; 
        const CALENDAR_ID = "cascadereservations@gmail.com"; 

        const checklistData = [
            {
                title: "Get Ready & Check", icon: "üîç",
                description: `<strong>üéØ What we're doing:</strong> Getting your tools ready and checking for problems FIRST.<br><br><strong>üí° Why it helps:</strong> Seeing everything clearly with lights and fresh air makes cleaning easier and stops you from cleaning over a problem.<div class="warning-box"><div class="icon">‚ö†Ô∏è</div><div class="content"><div class="title">IMPORTANT: Found a Problem?</div><div class="instruction">If you see something broken, a bad stain, or find that something is missing, <strong>stop!</strong> Take a picture right away and report it to us. This is very important to get it fixed or to charge the last guest.</div></div></div>`,
                hasPhotos: true,
                photoTitle: "üì∏ Take Photos of Any Problems",
                photoHint: "If you see broken items, missing things, or stains, take a photo. This protects you and helps fix problems faster.",
                hasNotes: true,
                notesTitle: "üìù Write Down Any Problems You Found:",
                items: [
                    { id: "check_0_1", text: "Get all your cleaning tools ready", detail: "Grab your: cleaning sprays, cloths (at least 4), vacuum, mop, fresh bed sheets, fresh towels, bathroom supplies (soap, shampoo), coffee packs (2), water bottles (2), and tissues." },
                    { id: "check_1_1", text: "Knock and say 'Housekeeping', then open all windows and turn on all lights", detail: "Knock 3 times loudly. Open windows for fresh air. Turn on every light so you can see dirt clearly. <code>Important:</code> This step is primarily for mid-stay cleaning when a guest may be present." },
                    { id: "check_1_4", text: "Test if everything works (TV, WiFi, AC, lights, ref, microwave)", detail: "Turn on the TV and test the remote. Check if WiFi works on your phone. Turn on AC to feel if it's cooling. Flip every light switch. Check if the refrigerator is cold and the microwave powers on." },
                    { id: "check_1_5", text: "Look for broken things or water leaks", detail: "Check under sinks for drips. Look at walls for cracks or stains. Check furniture for damage. Look around the AC for water." },
                    { id: "check_1_7", text: "Search everywhere for items guests left behind", detail: "Important spots to check: inside drawers, under the bed, behind doors, between mattress and headboard, under couch cushions." },
                    { id: "check_1_8", text: "Check all plants (Snake Plants) and water ONLY if soil is very dry", detail: "Gently press finger 1-2 inches into soil. Snake plants need water only 1-2 times per week when soil is completely dry. <strong>IMPORTANT:</strong> If NO guest is coming the next day, put all plants outside on the balcony for fresh air and sunlight. Bring them back inside before the next guest arrives.", disinfect: false }
                ]
            },
            {
                title: "Remove & Let Chemicals Work", icon: "‚è≥",
                description: "<strong>üéØ What we're doing:</strong> We take out trash and spray cleaning products, then WAIT. This is the secret to easy cleaning!<br><br><strong>üí° Why waiting helps:</strong> When you spray cleaner and let it sit (5-10 minutes), it breaks down dirt automatically. If you spray and wipe immediately, you have to scrub really hard. Waiting makes your job easier!",
                items: [
                    { id: "check_2_1", text: "Take out all trash and throw away any food or containers", detail: "Check every room (bedroom, bathroom, kitchen, balcony). Put everything in trash bags. This stops bad smells from spreading." },
                    { id: "check_2_4", text: "Take off all bed sheets and towels, start washing them", detail: "Remove all bedding and towels. If you see stains, spray them first. Put them in the washing machine NOW so it works while you clean." },
                    { id: "check_3_1", text: "Spray cleaner inside toilet and all over shower/bathtub", detail: "Spray EVERYWHERE in the toilet (especially under the rim). Spray the shower walls from top to bottom. DON'T SCRUB YET - just spray and leave it!", disinfect: false },
                    { id: "check_3_4", text: "Spray kitchen cleaner on stove and inside microwave", detail: "First, check if they look clean and have no bad smell. If they are clean, just wipe them with a clean cloth. If you see grease or dirt, spray them well and let it sit for 10-15 minutes before scrubbing." }
                ]
            },
            {
                title: "Clean Bedroom & Living Room", icon: "üõèÔ∏è",
                description: "<strong>üéØ What we're doing:</strong> Clean from high to low, dust before wet cleaning.<br><br><strong>üí° Why this order:</strong> Dust falls down when you clean. So we start at the ceiling and work our way down. We dust BEFORE mopping because dust + water = mud!",
                hasPhotos: true,
                photoTitle: "üì∏ Take Photos of Finished Bedroom *REQUIRED*", photoRequired: true,
                photoHint: "Stand at the doorway and take a photo showing the whole room. Make sure the bed looks perfect!",
                items: [
                    { id: "check_4_1", text: "Wipe dust from top to bottom", detail: "Start high (ceiling fans, light fixtures) then middle (shelves, tables, picture frames) then low (baseboards). Clean windows and window sills too." },
                    { id: "check_4_5", text: "Clean and disinfect things people touch a lot<span class='disinfect-badge'>ü¶† Disinfect</span>", detail: "Use disinfectant spray on: light switches, TV remote, AC remote, door handles (both sides), thermostat.", disinfect: true },
                    { id: "check_5_2", text: "Make the bed perfectly (like in hotels)", detail: "Pull sheets tight with no wrinkles. Make hospital corners at the bottom (tuck in tightly). Make it look crisp and professional." },
                    { id: "check_5_6", text: "Fluff pillows and arrange them nicely", detail: "Shake pillows hard to make them puffy. Arrange them perfectly straight and even. This makes the bed look luxurious." },
                    { id: "check_5_7", text: "Check and refill the room fragrance", detail: "Look at the bottle of the room perfume. If it's almost empty, fill it up so the room smells nice for the new guest." },
                    { id: "check_5_8", text: "Arrange items and clean mirrors", detail: "Put everything back in its special spot: the TV remote, AC remote, plants, and tissue box. Make sure all mirrors are super clean with no fingerprints." }
                ]
            },
            {
                title: "Clean Kitchen & Bathroom", icon: "üíß",
                description: "<strong>üéØ What we're doing:</strong> Now the cleaners have been sitting, so dirt comes off easily! These rooms MUST be spotless.<br><br><strong>üí° Why these rooms matter most:</strong> Guests judge cleanliness mainly by the bathroom and kitchen. Everything must sparkle and be completely dry.",
                hasPhotos: true,
                photoTitle: "üì∏ Take Photos of Finished Kitchen & Bathroom *REQUIRED*", photoRequired: true,
                photoHint: "Show how clean and shiny everything looks - especially the sink, mirrors, and appliances.",
                items: [
                    { id: "check_7_4", text: "Scrub, disinfect and clean the toilet, shower, and sink<span class='disinfect-badge'>ü¶† Disinfect</span>", detail: "Now scrub the toilet (remember, the cleaner has been sitting!). Scrub shower and tub, then rinse well with water. Clean the sink and make the faucet shine.", disinfect: true },
                    { id: "check_7_2", text: "Clean mirrors and glass until there are NO streaks", detail: "Pro trick: After cleaning shower glass, use a squeegee (rubber wiper) to dry it completely. This stops water spots and looks professional." },
                    { id: "check_7_5", text: "Check toilet smell and clean the bathroom vent", detail: "Does the toilet area smell bad? If yes, report it. Also, look at the vent above the mirror. If you see dust, use a vacuum or broom to clean it all off." },
                    { id: "check_6_1", text: "Clean inside and outside of all kitchen appliances", detail: "Clean inside microwave (no oil or food). Wipe outside of fridge, rice cooker, kettle. Make the stovetop shiny." },
                    { id: "check_6_4", text: "Clean, disinfect and polish sink, faucet, and counters<span class='disinfect-badge'>ü¶† Disinfect</span>", detail: "Make the faucet SUPER shiny - this shows you did a detailed job. Wipe all counters including edges and backsplash.", disinfect: true },
                    { id: "check_6_5", text: "Check the dishwashing sponge", detail: "Is the sponge old, wet, or yucky? Put a brand new, dry one for the guest. Wash and dry the old one if it's still okay to be used next time." },
                    { id: "check_7_7", text: "Refill all bathroom and kitchen supplies", detail: "Fold towels neatly (in thirds). Check and refill: hand soap, body wash, shampoo, dish soap. Ensure guest amenities are complete: coffee packs (2), water bottles (2), and full toiletries." },
                ]
            },
            {
                title: "Final Touches & Quality Check", icon: "‚ú®",
                description: "<strong>üéØ What we're doing:</strong> This is the final step to make everything PERFECT.<br><br><strong>üí° Pro tip:</strong> Clean floors LAST and work backward toward the door so you don't step on clean floors. Vacuum before mopping so you don't spread dust.",
                hasPhotos: true,
                photoTitle: "üì∏ Take Final Photos of Whole Unit *REQUIRED*", photoRequired: true,
                photoHint: "Show the complete transformation. These photos prove your excellent work!",
                hasNotes: true,
                notesTitle: "üìù Final Notes & Summary",
                items: [
                    { id: "check_8_1", text: "Vacuum then mop all floors", detail: "Start from the far corner and work backward toward the exit. This way you don't step on clean floors." },
                    { id: "check_balcony", text: "Clean and disinfect the balcony table, chairs, and railing<span class='disinfect-badge'>ü¶† Disinfect</span>", detail: "Wipe down outdoor furniture so guests can enjoy the balcony too.", disinfect: true },
                    { id: "check_9_1", text: "Walk through as if you're a guest - check for fingerprints and dust", detail: "Pretend you just arrived as a guest. Look for smudges on mirrors, glass, chrome, and door handles. Wipe them off." },
                    { id: "check_9_4", text: "Set up the room perfectly for guests", detail: "Set AC to 23¬∞C. Turn on soft lights (like bedside lamps). Make sure decorations are straight. <strong>Crucially, ensure the refrigerator is switched on and getting cold for the guest.</strong>" },
                    { id: "check_10_6", text: "Final power & safety check before leaving", detail: `What to do with power before you leave? It depends on when the next guest comes.<div class="scenario-box"><div class="icon">‚òÄÔ∏è</div><div class="content"><div class="title">IF a guest is coming TODAY (before 2 PM):</div><div class="instruction">Leave the <strong class="on">fridge</strong> and the <strong class="on">water heater</strong> ON. Turn <strong class="off">OFF</strong> all the lights. The aircon can be turned on later when the guest is very close to arriving.</div></div></div><div class="scenario-box"><div class="icon">üåô</div><div class="content"><div class="title">IF a guest is coming LATER or NO GUEST today:</div><div class="instruction">Walk around and turn <strong class="off">OFF</strong> everything. Then, go to the breaker box. Find the switch for the <strong class="off">Water Heater</strong> and flip it <strong class="off">OFF</strong>. Leave all other switches ON for the WiFi and cameras.</div></div></div>Finally, make sure all windows are closed and the front door is locked.` }
                ]
            }
        ];

        const weeklyMaintenanceData = {
            title: "üîß Weekly Deep Maintenance", 
            icon: "üßπ",
            description: `<strong>üéØ Saturday/Sunday Special Tasks:</strong> These deeper cleaning tasks ensure the unit stays in top condition.<br><br><strong>üí° Why weekly matters:</strong> Regular deep maintenance prevents buildup and keeps appliances running efficiently.`,
            hasPhotos: true,
            photoTitle: "üì∏ Take Photos of Deep Cleaned Items",
            photoHint: "Document your weekly maintenance work - especially before/after of heavily cleaned items.",
            hasNotes: true,
            notesTitle: "üìù Weekly Maintenance Notes:",
            items: [
                { id: "weekly_1", text: "Deep clean sofa and mattress by vacuuming with dust-mite vacuum", detail: "Sofa: Go over arms, back, cushions (both sides). Mattress: Vacuum both sides completely. This removes allergens and dust mites.", disinfect: false },
                { id: "weekly_2", text: "Empty vacuum dust collector and clean filter", detail: "Remove dust bin, empty completely. Wash or tap clean the vacuum filter. Let dry before reassembling.", disinfect: false },
                { id: "weekly_3", text: "Deep clean refrigerator<span class='disinfect-badge'>ü¶† Disinfect</span>", detail: "Remove shelves and drawers, wash with soapy water. Wipe interior walls and door seals. Vacuum back coils if accessible.", disinfect: true },
                { id: "weekly_4", text: "Clean AC filters<span class='disinfect-badge'>ü¶† Disinfect</span>", detail: "Turn off AC. Remove filters, wash with mild soap and water. Let dry completely (30+ mins) before reinstalling.", disinfect: true },
                { id: "weekly_5", text: "Clean air purifier - vacuum filter and wipe exterior", detail: "Turn off unit. Use vacuum to remove dust from filter (don't wash). Wipe down exterior housing and vents.", disinfect: false },
                { id: "weekly_6", text: "Descale iron steamer", detail: "Empty water tank. Run descaling solution (or 1:1 white vinegar + water). Steam cycle, then rinse thoroughly.", disinfect: false },
                { id: "weekly_7", text: "Vacuum behind/under furniture", detail: "Move lightweight furniture safely. Vacuum corners, baseboards, and hard-to-reach areas.", disinfect: false },
                { id: "weekly_8", text: "üîπ BIWEEKLY (2nd & 4th week): Change sofa cover and mattress protector", detail: "Remove sofa cover and mattress protector. Replace with clean ones. Wash the removed covers.", disinfect: false, biweekly: true },
                { id: "weekly_9", text: "üîπ BIWEEKLY (2nd & 4th week): Liquid Sosa Treatment", detail: "‚úã ONLY if NO guest is coming the next day: Pour liquid sosa down CR toilet/sink and kitchen sink drains. Leave overnight to prevent clogs. Flush with water in the morning before guest arrives.", disinfect: false, biweekly: true }
            ]
        };

        let allPhotos = {};
        let currentCardIndex = 0;
        let isDirty = false;

        const cardContainer = document.querySelector('.card-container');
        const navTabsContainer = document.querySelector('.navigation-tabs');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submissionModal = document.getElementById('submissionModal');
        const errorModal = document.getElementById('errorModal');
        const submitMessageDiv = document.getElementById('submitMessage');

        function isWeekend() {
            const today = new Date().getDay();
            return today === 0 || today === 6;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const initialCardData = { title: "Your Info", icon: "üë§", isInfoCard: true };
            let sectionsToUse = [...checklistData];
            
            if (isWeekend()) {
                sectionsToUse.splice(sectionsToUse.length - 1, 0, weeklyMaintenanceData);
            }
            
            const allSections = [initialCardData, ...sectionsToUse];
            generateHTML(allSections);
            setupEventListeners(allSections.length);
            setupSwipeListeners();
            showCard(0);
            updateProgress();
            loadDraft();
            
            window.addEventListener('beforeunload', (e) => {
                if (isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
        
        function generateHTML(sections) {
            let cardsHTML = '';
            let tabsHTML = '';
            sections.forEach((section, index) => {
                const sectionId = `section_${index}`;
                if (!section.isInfoCard) allPhotos[sectionId] = [];
                
                const weeklyClass = section.title.includes('Weekly') ? 'weekly' : '';
                tabsHTML += `<div class="nav-tab ${weeklyClass}" data-index="${index}"><span class="icon">${section.icon}</span><span class="label">${section.title}</span></div>`;
                
                cardsHTML += `<div class="card" id="${sectionId}" data-index="${index}">`;
                cardsHTML += `<h2>${section.icon} ${section.title}</h2>`;

                if (section.isInfoCard) {
                    cardsHTML += `<div class="info-field-grid">
                      <div class="info-field"><label for="unitName">Property Name</label><input type="text" id="unitName" name="unitName" value="Cascade Bria" readonly></div>
                      <div class="info-field"><label for="cleanerName">üë§ Your Full Name *</label><input type="text" id="cleanerName" name="cleanerName" required placeholder="Select or type a name" list="cleaner-list"><datalist id="cleaner-list"><option value="Hazel Ann"></option><option value="Ate Kriss"></option><option value="Others"></option></datalist></div>
                      <div class="info-field"><label for="startTime">‚è∞ Start Time *</label><input type="time" id="startTime" name="startTime" required></div>
                      <div class="info-field"><label for="elapsedTime">‚è∞ Time Elapsed</label><input type="text" id="elapsedTime" name="elapsedTime" value="00:00:00" readonly style="font-family: 'Courier New', monospace; font-weight:600; font-size:1.1em; color:var(--primary-green); letter-spacing:1px;"></div>
                    </div>`;
                } else {
                    if (section.description) cardsHTML += `<div class="section-description">${section.description}</div>`;
                    section.items.forEach(item => {
                        const disinfectClass = item.disinfect ? 'disinfect' : '';
                        const biweeklyClass = item.biweekly ? 'biweekly' : '';
                        const combinedClass = `${disinfectClass} ${biweeklyClass}`.trim();
                        cardsHTML += `<div class="checklist-item ${combinedClass}">
                            <input type="checkbox" id="${item.id}" data-section-index="${index}">
                            <label for="${item.id}">${item.text}<div class="item-detail">${item.detail}</div></label>
                        </div>`;
                    });
                     if (section.hasPhotos || section.hasNotes) {
                        cardsHTML += `<div class="pro-tip" style="background: var(--surface); border-color: var(--border);">`;
                        if (section.hasPhotos) {
                            cardsHTML += `<div class="photo-upload">
                                <h4>${section.photoTitle}</h4>
                                <div class="photo-hint">${section.photoHint}</div>
                                <div class="photo-btn-group">
                                    <label for="camera_${sectionId}" class="photo-upload-btn primary">üì∑ Use Camera</label>
                                    <input type="file" id="camera_${sectionId}" accept="image/*" capture="environment" data-section-id="${sectionId}">
                                    
                                    <label for="attach_${sectionId}" class="photo-upload-btn">üìé Attach Files</label>
                                    <input type="file" id="attach_${sectionId}" accept="image/*" multiple data-section-id="${sectionId}">
                                </div>
                                <div id="preview_${sectionId}" class="photo-preview"></div>
                            </div>`;
                        }
                        if (section.hasNotes) {
                            cardsHTML += `<div class="notes-area" style="margin-top: 1.5rem;">
                                <label style="font-weight: 600; font-size: 1.05em; color: var(--primary-green);">${section.notesTitle}</label>
                                <div class="urgent-checkbox-wrapper" style="margin-top: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="urgent_${sectionId}" style="width: 1.2em; height: 1.2em; margin-top: 0; flex-shrink: 0;">
                                    <label for="urgent_${sectionId}" style="cursor: pointer; font-weight: 700; color: var(--error); font-size: 0.95em; margin: 0;">Mark as URGENT (e.g., broken item, leak)</label>
                                </div>
                                <textarea id="notes_${sectionId}" name="notes_${sectionId}" placeholder="Example: Bathroom light switch not working, need electrician..."></textarea>
                            </div>`;
                        }
                        cardsHTML += '</div>';
                    }
                }
                cardsHTML += `</div>`;
            });
            cardContainer.innerHTML = cardsHTML;
            navTabsContainer.innerHTML = tabsHTML;
        }

        function setupEventListeners(totalCards) {
            navTabsContainer.addEventListener('click', e => {
                if (e.target.closest('.nav-tab')) showCard(parseInt(e.target.closest('.nav-tab').dataset.index));
            });
            prevBtn.addEventListener('click', () => showCard(currentCardIndex - 1));
            nextBtn.addEventListener('click', () => (currentCardIndex === totalCards - 1) ? handleSubmission() : showCard(currentCardIndex + 1));
            
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', () => {
                updateProgress();
                updateSectionCompletionStatus(cb.dataset.sectionIndex);
                isDirty = true;
            }));
            document.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('input', () => isDirty = true);
            });
            document.querySelectorAll('input[type="file"]').forEach(input => input.addEventListener('change', handlePhotoUpload));
            
            document.getElementById('modal-go-back').addEventListener('click', () => submissionModal.style.display = 'none');
            document.getElementById('modal-confirm-action').addEventListener('click', () => {
                submissionModal.style.display = 'none';
                proceedWithSubmission();
            });
            document.getElementById('error-modal-close').addEventListener('click', () => errorModal.style.display = 'none');
        }
        
        function setupSwipeListeners() {
            let touchstartX = 0;
            let touchendX = 0;
            const swipeThreshold = 50;

            cardContainer.addEventListener('touchstart', function(event) {
                touchstartX = event.changedTouches[0].screenX;
            }, { passive: true });

            cardContainer.addEventListener('touchend', function(event) {
                touchendX = event.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true }); 

            function handleSwipe() {
                if (touchendX < touchstartX - swipeThreshold) {
                    const totalCards = document.querySelectorAll('.card').length;
                    if(currentCardIndex < totalCards - 1) { showCard(currentCardIndex + 1); }
                }
                if (touchendX > touchstartX + swipeThreshold) {
                     if(currentCardIndex > 0) { showCard(currentCardIndex - 1); }
                }
            }
        }
        
        function showCard(index) {
            const cards = document.querySelectorAll('.card');
            const tabs = document.querySelectorAll('.nav-tab');
            if (index < 0 || index >= cards.length) return;
            currentCardIndex = index;
            
            cardContainer.style.height = (cardContainer.offsetHeight || 500) + 'px';
            
            cards.forEach((c, i) => c.classList.toggle('active', i === index));
            tabs.forEach((t, i) => {
                t.classList.toggle('active', i === index)
                if (i === index) {
                    t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });
            
            setTimeout(() => {
                const activeCard = document.querySelector('.card.active');
                if (activeCard) {
                     cardContainer.style.height = activeCard.offsetHeight + 'px';
                }
            }, 500);

            prevBtn.disabled = index === 0;
            nextBtn.textContent = index === cards.length - 1 ? '‚úÖ Submit Report' : 'Next ‚Üí';
            nextBtn.id = index === cards.length - 1 ? 'submitBtn' : 'nextBtn';
        }
        
        function updateProgress() {
            const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
            const checked = document.querySelectorAll('.checklist-item input[type="checkbox"]:checked');
            
            const percentage = checkboxes.length > 0 ? Math.round((checked.length / checkboxes.length) * 100) : 0;
            document.querySelector('.percentage').textContent = `${percentage}%`;
            document.querySelector('.progress-fill').style.width = `${percentage}%`;
            
            checkboxes.forEach(cb => {
                const item = cb.closest('.checklist-item');
                if (item) {
                    item.classList.toggle('checked', cb.checked);
                }
            });
        }
        
        function updateSectionCompletionStatus(sectionIndex) {
            const sectionCard = document.querySelector(`.card[data-index='${sectionIndex}']`);
            const navTab = document.querySelector(`.nav-tab[data-index='${sectionIndex}']`);
            if (!sectionCard || !navTab) return;
            
            const checkboxes = sectionCard.querySelectorAll('.checklist-item input[type="checkbox"]');
            
            if (checkboxes.length > 0) {
                navTab.classList.toggle('completed', Array.from(checkboxes).every(cb => cb.checked));
            }
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const MAX_WIDTH = 1280;
                const MAX_HEIGHT = 1280;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handlePhotoUpload(event) {
            const input = event.target;
            const sectionId = input.dataset.sectionId;
            const previewContainer = document.getElementById(`preview_${sectionId}`);
            
            for (const file of Array.from(input.files)) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`‚ùå File ${file.name} is too large (max 10MB).`);
                    continue;
                }
                try {
                    const compressedDataUrl = await compressImage(file);
                    const photoIndex = allPhotos[sectionId].push({ name: file.name, data: compressedDataUrl }) - 1;
                    
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview-item';
                    photoDiv.innerHTML = `<img src="${compressedDataUrl}" alt="${file.name}"><button type="button" class="remove-photo" data-section-id="${sectionId}" data-photo-index="${photoIndex}">√ó</button>`;
                    previewContainer.appendChild(photoDiv);
                    
                    photoDiv.querySelector('.remove-photo').addEventListener('click', (e) => {
                        const sId = e.target.dataset.sectionId;
                        const pIdx = parseInt(e.target.dataset.photoIndex);
                        allPhotos[sId].splice(pIdx, 1); 
                        loadDraftPhotosForSection(sId, previewContainer);
                    });
                    isDirty = true;
                } catch (error) {
                    console.error("Could not compress image:", error);
                    alert("Could not process image file. It might be corrupted.");
                }
            }
            input.value = '';
        }

        const loadDraftPhotosForSection = (sectionId, previewContainer) => {
            previewContainer.innerHTML = '';
            (allPhotos[sectionId] || []).forEach((photo, photoIndex) => {
                if (!photo) return;
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-preview-item';
                photoDiv.innerHTML = `<img src="${photo.data}" alt="${photo.name}"><button type="button" class="remove-photo" data-section-id="${sectionId}" data-photo-index="${photoIndex}">√ó</button>`;
                previewContainer.appendChild(photoDiv);
                
                photoDiv.querySelector('.remove-photo').addEventListener('click', (e) => {
                    const sId = e.target.dataset.sectionId;
                    const pIdx = parseInt(e.target.dataset.photoIndex);
                    allPhotos[sId].splice(pIdx, 1);
                    loadDraftPhotosForSection(sId, previewContainer);
                });
            });
        };

        function loadDraft() {
            const draft = localStorage.getItem('cleaningFormDraft');
            
            const applyDraft = (draftData) => {
                const { form, photos } = draftData;
                if (form) {
                    for (const key in form) {
                        if (key === 'elapsedTime') continue;
                        
                        const el = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                        if (el) {
                            if (el.type === 'checkbox') el.checked = form[key];
                            else el.value = form[key];
                        }
                    }
                }
                
                if (photos) {
                    allPhotos = {};
                    for (const sectionId in photos) {
                        allPhotos[sectionId] = photos[sectionId] || [];
                        const previewContainer = document.getElementById(`preview_${sectionId}`);
                        if (previewContainer) {
                            previewContainer.innerHTML = '';
                            allPhotos[sectionId].forEach((photo, photoIndex) => {
                                if (!photo) return;
                                const photoDiv = document.createElement('div');
                                photoDiv.className = 'photo-preview-item';
                                photoDiv.innerHTML = `<img src="${photo.data}" alt="${photo.name}"><button type="button" class="remove-photo" data-section-id="${sectionId}" data-photo-index="${photoIndex}">√ó</button>`;
                                previewContainer.appendChild(photoDiv);
                                
                                photoDiv.querySelector('.remove-photo').addEventListener('click', (e) => {
                                    const sId = e.target.dataset.sectionId;
                                    const pIdx = parseInt(e.target.dataset.photoIndex);
                                    allPhotos[sId].splice(pIdx, 1);
                                    loadDraftPhotosForSection(sId, previewContainer);
                                });
                            });
                        }
                    }
                }
                
                updateProgress();
                document.querySelectorAll('.nav-tab').forEach(t => updateSectionCompletionStatus(t.dataset.index));
                if (!document.getElementById('startTime').value) {
                    setStartTime();
                }
                isDirty = false;
            };

            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.id = 'draftModal';
                    modal.style.display = 'flex';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3 id="modal-title">üìã Unsaved Work Found</h3>
                            <p id="modal-message">Would you like to continue where you left off?</p>
                            <div class="modal-buttons">
                                <button class="modal-btn" id="draft-discard" type="button">Discard</button>
                                <button class="modal-btn" id="draft-load" type="button" style="background:linear-gradient(135deg, var(--earthen-gold) 0%, #b39a7d 100%); color:#fff;">Load Draft</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    
                    document.getElementById('draft-load').onclick = () => {
                        applyDraft(draftData);
                        modal.remove();
                    };
                    document.getElementById('draft-discard').onclick = () => {
                        localStorage.removeItem('cleaningFormDraft');
                        setStartTime();
                        modal.remove();
                    };
                    
                } catch (e) {
                    console.error("Failed to parse draft:", e);
                    localStorage.removeItem('cleaningFormDraft');
                    setStartTime();
                }
            } else {
                setStartTime();
            }
        }

        function setStartTime() {
            if (!document.getElementById('startTime').value) {
                const now = new Date();
                document.getElementById('startTime').value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            }
        }
        
        function handleSubmission() {
            if (!SCRIPT_URL || SCRIPT_URL.includes("...")) {
                const em = document.getElementById('errorModal');
                if(em) {
                    document.getElementById('error-modal-title').textContent = '‚ùå SCRIPT_URL Not Set';
                    document.getElementById('error-modal-message').innerHTML = '<p>The SCRIPT_URL is not set correctly. Please deploy your Apps Script and paste the full URL into this HTML file.</p>';
                    em.style.display = 'flex';
                } else {
                    console.error("ERROR: The SCRIPT_URL is not set correctly.");
                }
                return;
            }

            let missingRequiredPhotos = [];
            const allSectionsData = isWeekend() ? [...checklistData.slice(0, -1), weeklyMaintenanceData, checklistData[checklistData.length - 1]] : checklistData;
            
            allSectionsData.forEach((section, idx) => {
                if (section.photoRequired) {
                    const sectionId = `section_${idx+1}`;
                    const photos = (allPhotos[sectionId] || []).filter(p => p !== null);
                    if (photos.length === 0) missingRequiredPhotos.push(section.title);
                }
            });
            
            if (missingRequiredPhotos.length > 0) {
                document.getElementById('modal-title').textContent = 'üì∏ Missing Required Photos';
                document.getElementById('modal-message').innerHTML = `You must upload photos for: <strong>${missingRequiredPhotos.join(', ')}</strong>`;
                document.getElementById('modal-confirm-action').style.display = 'none';
                document.getElementById('modal-go-back').textContent = 'Go Back & Add Photos';
                submissionModal.style.display = 'flex';
                return;
            }

            document.getElementById('modal-confirm-action').style.display = 'inline-block';
            document.getElementById('modal-go-back').textContent = 'Go Back & Review';

            const unchecked = document.querySelectorAll('.checklist-item input[type="checkbox"]:not(:checked)');
            if (unchecked.length > 0) {
                document.getElementById('modal-title').textContent = '‚ö†Ô∏è Incomplete Items';
                document.getElementById('modal-message').textContent = `You have ${unchecked.length} unchecked item(s). Continue anyway?`;
                document.getElementById('modal-confirm-action').textContent = 'Submit As‚ÄëIs';
                submissionModal.style.display = 'flex';
            } else {
                proceedWithSubmission();
            }
        }

        async function proceedWithSubmission() {
          const submitBtn = document.getElementById('submitBtn') || document.getElementById('nextBtn');
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'Submitting... <span class="loading-spinner"></span>';
          submitMessageDiv.style.display = 'none';

          try {
            const formData = new FormData(document.getElementById('cleaningForm'));
            const data = Object.fromEntries(formData.entries());
            const now = new Date();
            data.endTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            data.isWeekendCleaning = isWeekend();

            let allNotes = [];
            document.querySelectorAll('textarea[id^="notes_"]').forEach((ta) => {
              const value = (ta.value || '').trim();
              if (!value) return;
              
              const sectionId = ta.id.replace('notes_','');
              const idParts = sectionId.split('_');
              const idx = parseInt(idParts[idParts.length - 1]);
              
              const allSectionsData = isWeekend() ? [...checklistData.slice(0, -1), weeklyMaintenanceData, checklistData[checklistData.length - 1]] : checklistData;
              const sectionTitle = allSectionsData[idx-1].title;
              
              const urgentEl = document.getElementById(ta.id.replace('notes_', 'urgent_'));
              
              const prefix = (urgentEl && urgentEl.checked) ? '[URGENT] ' : '';
              allNotes.push(`[${sectionTitle}]: ${prefix}${value}`);
            });
            data.allNotes = allNotes.join('\n\n');

            const finalPhotos = {};
            for (const key in allPhotos) {
                finalPhotos[key] = (allPhotos[key] || []).filter(p => p !== null);
            }

            const allSectionsData = isWeekend() ? [...checklistData.slice(0, -1), weeklyMaintenanceData, checklistData[checklistData.length - 1]] : checklistData;
            const checklistDetails = allSectionsData.map((section) => ({
              title: section.title,
              icon: section.icon,
              items: section.items.map((item) => ({ text: item.text, checked: !!document.getElementById(item.id)?.checked }))
            }));

            const calendarData = {
              calendarId: CALENDAR_ID,
              summary: `Cleaning Report - ${data.cleanerName}`,
              description: `Cleaning completed by ${data.cleanerName}\nStart: ${data.startTime}\nEnd: ${data.endTime}\nCompletion Rate: ${Math.round((checklistDetails.reduce((sum, s) => sum + s.items.filter(i => i.checked).length, 0) / checklistDetails.reduce((sum, s) => sum + s.items.length, 0)) * 100)}%${data.allNotes ? '\n\nNotes:\n' + data.allNotes : ''}`,
              startDateTime: new Date().toISOString(),
              endDateTime: new Date(Date.now() + 3600000).toISOString()
            };

            const payload = { formData: data, photos: finalPhotos, checklistDetails, calendarData };

            const controller = new AbortController();
            const to = setTimeout(() => controller.abort(), 30000);
            const resp = await fetch(SCRIPT_URL, { method:'POST', mode:'cors', body: JSON.stringify(payload), signal: controller.signal });
            clearTimeout(to);

            if (!resp.ok) throw new Error(`Server responded with ${resp.status}`);
            const result = await resp.json();
            if (result.status !== 'success') throw new Error(result.message || 'Script error');

            submitMessageDiv.className = 'submit-message success';
            submitMessageDiv.textContent = '‚úÖ Report submitted! The email and spreadsheet have been updated.';
            localStorage.removeItem('cleaningFormDraft');
            isDirty = false;

            const sm = document.getElementById('successModal');
            if (sm) {
              sm.style.display = 'flex';
              const nb = document.getElementById('success-new-report-btn');
              if (nb) nb.onclick = () => location.reload();
            }
          } catch (err) {
            console.error('Submission error:', err);
            if (err.name === 'AbortError') {
              submitMessageDiv.className = 'submit-message error';
              submitMessageDiv.textContent = '‚ùå Submission Error: Request timed out. Please check your connection and try again.';
            } else if ((err.message||'').includes('Folder ID')) {
              errorModal.style.display = 'flex';
            } else {
              submitMessageDiv.className = 'submit-message error';
              submitMessageDiv.textContent = `‚ùå Submission Error: ${err.message || err}. Please verify your Google Apps Script deployment.`;
            }
          } finally {
            if (document.body.contains(submitBtn)) {
              submitMessageDiv.style.display = 'block';
              submitBtn.disabled = false;
              submitBtn.textContent = '‚úÖ Submit Report';
            }
          }
        }

document.addEventListener('DOMContentLoaded', () => {
  const st = document.getElementById('startTime');
  if (st) {
    const tick = () => {
      try {
        const el = document.getElementById('elapsedTime');
        if (!st.value || !el) return (el && (el.value = '00:00:00'));
        const [h,m] = st.value.split(':').map(Number);
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h||0, m||0);
        let diff = Math.max(0, now - start);
        const s = Math.floor((diff/1000)%60), mm = Math.floor((diff/60000)%60), hh = Math.floor(diff/3600000);
        el.value = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      } catch(e) { }
    };
    setInterval(tick, 1000); st.addEventListener('input', () => setTimeout(()=>tick(), 50)); tick();
  }

  const sdb = document.getElementById('saveDraftBtn');
  if (sdb) {
    sdb.addEventListener('click', () => {
      try {
        const fd = new FormData(document.getElementById('cleaningForm'));
        const data = Object.fromEntries(fd.entries());
        const photosToSave = {};
        for (const key in allPhotos) {
            photosToSave[key] = (allPhotos[key] || []).filter(p => p !== null);
        }
        localStorage.setItem('cleaningFormDraft', JSON.stringify({ form: data, photos: photosToSave }));
        sdb.classList.add('saved'); setTimeout(()=>sdb.classList.remove('saved'), 1400);
        isDirty = false;
      } catch (e) { console.warn('Save draft failed', e); }
    });
  }

  const emc = document.getElementById('error-modal-close');
  if (emc) emc.addEventListener('click', ()=>{ const em = document.getElementById('errorModal'); if (em) em.style.display='none'; });
});
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  }
</script>
<script src="install.js" defer></script>


<div class="modal" id="inventoryModal" style="display:none;">
  <div class="modal-content">
    <h3>üß¥ Update Consumables</h3>
    <p style="margin-top:-0.35rem; color:var(--text-secondary);">
      <strong>Stock Levels</strong><span id="invLastUpdated">‚Ä¢ Last Updated: ‚Äî</span>
    </p>
    <div id="invError"></div>
    <div class="inv-scroll">
      <table class="inv-table" id="invTable">
        <thead>
          <tr>
            <th>Item</th>
            <th>Current ROB</th>
            <th>Consume</th>
            <th>Unit</th>
            <th>New ROB</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-buttons" style="justify-content: space-between;">
      <button class="modal-btn" id="invCancelBtn" type="button">Cancel</button>
      <div style="display:flex; gap:0.5rem; align-items:center;">
        <button class="modal-btn" id="invPrefillBtn" type="button" title="Prefill suggested amounts">‚Üª Prefill</button>
        <button class="modal-btn" id="invSaveBtn" type="button" style="background:linear-gradient(135deg, var(--earthen-gold) 0%, #b39a7d 100%); color:#fff;">Update Inventory</button>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="successModal" style="display:none;">
<div class="modal-content">
<h3 style="color:var(--success);">‚úÖ Report Submitted!</h3>
<p>Thank you! The Google Sheet and email report have been successfully updated.</p>
<div class="modal-buttons">
<button class="modal-btn" id="success-new-report-btn" style="background:linear-gradient(135deg, var(--earthen-gold) 0%, #b39a7d 100%); color:#fff;" type="button">Start New Report</button>
</div>
</div>
</div>

<script>
(() => {
  const INVENTORY_API_URL = "https://script.google.com/macros/s/AKfycbxKpNS04OMGXtEW-XLPbRkw9P6n5Tek_SnvVQD02T06StFq7uVBlKljhyzJNMQ75x7U/exec";
  const CONSUMABLES = [
    { key: "hand_soap_ml",   name: "Hand soap",     unit: "ml",      default: 30 },
    { key: "body_wash_ml",   name: "Body wash",     unit: "ml",      default: 30 },
    { key: "shampoo_ml",     name: "Shampoo",       unit: "ml",      default: 30 },
    { key: "dish_soap_ml",   name: "Dish soap",     unit: "ml",      default: 25 },
    { key: "coffee_packs",   name: "Coffee packs",  unit: "pcs",     default: 2  },
    { key: "coffee_sticks",  name: "Coffee sticks", unit: "pcs",     default: 2  },
    { key: "water_bottles",  name: "Water bottles", unit: "bottles", default: 2  },
    { key: "tea",            name: "Tea",           unit: "pcs",     default: 0  },
    { key: "toiletries",     name: "Toiletries",    unit: "set",     default: 0  }
  ];

  let invCache = { items: {}, lastUpdated: null };
  const el = (id) => document.getElementById(id);

  function findCheckbox(id){ return document.getElementById(id); }

  function openInventoryModal() {
    const modal = el('inventoryModal');
    if (!modal) return;
    modal.style.display = 'flex';
    el('invError').style.display = 'none';
    loadInventory().then(buildInvTable).catch(err => {
      console.error('Inventory load error:', err);
      el('invError').textContent = 'Unable to load inventory at the moment. Please try again.';
      el('invError').style.display = 'block';
      // Still render rows with defaults
      buildInvTable({});
    });
  }

  function closeInventoryModal(uncheckRefill=false) {
    const modal = el('inventoryModal');
    if (modal) modal.style.display = 'none';
    if (uncheckRefill) {
      const cb = findCheckbox('check_7_7');
      if (cb) cb.checked = false;
      if (typeof updateProgress === 'function') updateProgress();
      if (typeof updateSectionCompletionStatus === 'function') {
        const si = cb?.dataset?.sectionIndex;
        if (si) updateSectionCompletionStatus(si);
      }
    }
  }

  function setLastUpdated(ts) {
    const d = ts ? new Date(ts) : new Date();
    const fmt = d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    el('invLastUpdated').textContent = '‚Ä¢ Last Updated: ' + fmt;
  }

  async function loadInventory() {
    // Try multiple endpoints for resilience
    let resp;
    try {
      resp = await fetch(INVENTORY_API_URL + "?action=getConsumables", { method: "GET" });
    } catch(_) {}
    if (!resp || !resp.ok) {
      try {
        resp = await fetch(INVENTORY_API_URL + "?action=consumables", { method: "GET" });
      } catch(_) {}
    }
    if (!resp || !resp.ok) {
      // final attempt without action
      resp = await fetch(INVENTORY_API_URL, { method: "GET" });
    }
    const data = await resp.json().catch(() => ({}));
    // Normalize
    const itemsArray = Array.isArray(data.items) ? data.items : (Array.isArray(data.consumables) ? data.consumables : []);
    const byName = {};
    itemsArray.forEach(it => {
      const name = (it.name || it.item || it.title || "").toString().trim().toLowerCase();
      if (!name) return;
      byName[name] = {
        stock: Number(it.stock ?? it.rob ?? it.quantity ?? 0),
        unit: it.unit || it.uom || '',
        id: it.id || null
      };
      if (it.lastUpdated) invCache.lastUpdated = it.lastUpdated;
    });
    invCache.items = byName;
    setLastUpdated(data.lastUpdated || invCache.lastUpdated || Date.now());
    return byName;
  }

  function getROB(name) {
    const key = name.toLowerCase();
    return invCache.items[key]?.stock ?? 0;
  }

  function buildInvTable() {
    const tbody = el('invTable').querySelector('tbody');
    tbody.innerHTML = '';
    CONSUMABLES.forEach(row => {
      const rob = getROB(row.name);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${row.name}</strong><br><small>(${row.default}${row.unit === 'ml' ? ' ml est.' : row.default ? ' '+row.unit+' est.' : ''})</small></td>
        <td><span data-rob-name="${row.name}">${rob}</span></td>
        <td><input type="number" min="0" step="${row.unit === 'ml' ? 5 : 1}" class="inv-qty" value="${row.default || 0}" data-consume-name="${row.name}"/></td>
        <td><span class="inv-unit">${row.unit}</span></td>
        <td class="inv-new" data-new-name="${row.name}">${Math.max(0, rob - (row.default || 0))}</td>
      `;
      tbody.appendChild(tr);
    });

    // events
    tbody.querySelectorAll('input[data-consume-name]').forEach(inp => {
      inp.addEventListener('input', () => {
        const name = inp.getAttribute('data-consume-name');
        const robEl = tbody.querySelector(`[data-rob-name="${name}"]`);
        const newEl = tbody.querySelector(`[data-new-name="${name}"]`);
        const rob = Number(robEl?.textContent || 0);
        const use = Math.max(0, Number(inp.value || 0));
        newEl.textContent = String(Math.max(0, rob - use));
      });
    });
  }

  async function saveInventory() {
    const cleaner = document.getElementById('cleanerName')?.value || '';
    const unitName = document.getElementById('unitName')?.value || '';
    const entries = [];
    document.querySelectorAll('#invTable tbody input[data-consume-name]').forEach(inp => {
      const name = inp.getAttribute('data-consume-name');
      const qty = Number(inp.value || 0);
      if (qty > 0) {
        const rowDef = CONSUMABLES.find(c => c.name === name);
        entries.push({
          name,
          delta: qty,                 // amount consumed
          direction: "out",           // consumption
          unit: rowDef?.unit || "",
          source: "Checklist",
          reason: "Refill all bathroom and kitchen supplies",
          unitName,
          by: cleaner
        });
      }
    });
    if (!entries.length) return;
    const payload = { action: "logConsumption", timestamp: new Date().toISOString(), entries };

    const res = await fetch(INVENTORY_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).catch(err => ({ ok:false, err }));

    if (!res || !res.ok) {
      el('invError').textContent = "Update failed. Please check connection or permissions.";
      el('invError').style.display = 'block';
      return;
    }
    const data = await res.json().catch(()=>({}));
    // optimistic update UI
    document.querySelectorAll('#invTable tbody input[data-consume-name]').forEach(inp => {
      const name = inp.getAttribute('data-consume-name');
      const robEl = document.querySelector(`#invTable [data-rob-name="${name}"]`);
      const newEl = document.querySelector(`#invTable [data-new-name="${name}"]`);
      const newVal = Number(newEl?.textContent || 0);
      if (robEl) robEl.textContent = String(newVal);
      if (inp) inp.value = "0";
    });
    setLastUpdated(Date.now());
    closeInventoryModal(false);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const cb = findCheckbox('check_7_7');
    if (cb) {
      cb.addEventListener('change', (e) => {
        if (e.target.checked) openInventoryModal();
      });
    }
    const cancelBtn = el('invCancelBtn');
    const saveBtn   = el('invSaveBtn');
    const prefillBtn= el('invPrefillBtn');
    if (cancelBtn) cancelBtn.addEventListener('click', () => closeInventoryModal(true));
    if (saveBtn)   saveBtn.addEventListener('click', () => saveInventory());
    if (prefillBtn)prefillBtn.addEventListener('click', () => {
      document.querySelectorAll('#invTable tbody input[data-consume-name]').forEach(inp => {
        const name = inp.getAttribute('data-consume-name');
        const def = CONSUMABLES.find(c => c.name === name)?.default || 0;
        inp.value = String(def);
        inp.dispatchEvent(new Event('input'));
      });
    });
    // Close modal on outside click
    const modal = el('inventoryModal');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeInventoryModal(true);
      });
    }
  });
})();
</script>
</body>
</html>
