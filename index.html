<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://api.web3forms.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://placehold.co;">
    <title>Cascade Hideaway - Gold Standard Checklist</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-green: #3D6E64;
            --brand-gold: #C89B52;
            --light-gold: #E0C492;
            --background: #F9F6F1;
            --text-dark: #222222;
            --text-light: #555555;
            --border-color: #EAE8E2;
            --success: #00332B;
            --error: #8C2A2A;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
        }
        
        .main-container {
            max-width: 900px;
            margin: 1rem auto;
            background: var(--white);
            border: 1px solid var(--border-color);
            box-shadow: 0 15px 50px rgba(0,0,0,0.08);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--brand-green);
            color: var(--white);
            padding: 2.5rem 1.5rem;
            text-align: center;
            position: relative;
        }
        
        .header::before, .header::after {
            content: '‚ú®';
            position: absolute;
            font-size: 80px;
            opacity: 0.1;
            z-index: 0;
        }
        .header::before {
            content: 'üåø';
            top: -10px;
            right: 0;
            transform: rotate(-15deg);
        }
        .header::after {
            bottom: -20px;
            left: -10px;
            font-size: 60px;
        }


        .header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3.2em;
            font-weight: 700;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-family: 'Lato', sans-serif;
            font-size: 1.1em;
            color: var(--light-gold);
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .progress-section {
            position: sticky;
            top: 0;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .progress-label .percentage {
            font-weight: 700;
            color: var(--brand-green);
            font-size: 1.2em;
        }

        .progress-track {
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-gold) 0%, var(--light-gold) 100%);
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 6px;
        }
        
        .info-field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .info-field label {
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: block;
        }

        .info-field input, .info-field select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Lato', sans-serif;
            background: var(--white);
            transition: all 0.2s ease;
        }
        
        .info-field input:focus, .info-field select:focus {
            outline: none;
            border-color: var(--brand-gold);
            box-shadow: 0 0 0 3px rgba(180, 138, 60, 0.2);
        }
        
        .checklist-body {
            position: relative;
        }
        
        .navigation-tabs {
            display: flex;
            overflow-x: auto;
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 1.5rem;
            scrollbar-width: none; /* Firefox */
        }
        .navigation-tabs::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        .nav-tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
            font-weight: 700;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .nav-tab.active {
            color: var(--brand-green);
            border-bottom-color: var(--brand-gold);
        }
        .nav-tab.completed {
            color: var(--brand-green);
        }
        .nav-tab .icon {
            margin-right: 0.5rem;
        }

        .card-container {
            position: relative;
            overflow: hidden;
            padding: 1.5rem;
            min-height: 500px; 
        }

        .card {
            top: 0; left: 0; width: 100%;
            padding: 1.5rem;
            opacity: 0; visibility: hidden;
            position: absolute;
            transform: translateX(20px);
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
        }

        .card.active {
            opacity: 1; visibility: visible;
            transform: translateX(0);
            position: relative;
        }
        
        .card h2 {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--brand-green);
        }

        .section-description {
            background-color: #F1EEE9; padding: 1rem;
            margin-bottom: 1.5rem; border-radius: 8px;
            border-left: 4px solid var(--brand-gold);
            font-size: 0.95em;
        }

        .pro-tip {
             background-color: rgba(200, 155, 82, 0.1); padding: 1rem;
            margin-top: 1.5rem; border-radius: 8px;
            border-left: 4px solid var(--light-gold);
            font-size: 0.95em;
        }
        .pro-tip strong { color: var(--brand-gold); }
        
        .checklist-item {
            padding: 1rem 0; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: flex-start; gap: 1rem;
        }
        .checklist-item:last-child { border-bottom: none; }
        
        .checklist-item input[type="checkbox"] {
            -webkit-appearance: none; appearance: none;
            margin-top: 5px; width: 1.5em; height: 1.5em;
            border: 2px solid var(--border-color); border-radius: 6px;
            display: grid; place-content: center; flex-shrink: 0;
            cursor: pointer;
        }

        .checklist-item input[type="checkbox"]::before {
            content: ""; width: 0.8em; height: 0.8em;
            transform: scale(0); transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--brand-gold);
            transform-origin: bottom left;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .checklist-item input[type="checkbox"]:checked::before { transform: scale(1); }

        .checklist-item label {
            flex: 1; cursor: pointer; font-weight: 700;
            transition: color 0.3s ease;
        }

        .checklist-item.checked label {
            text-decoration: line-through;
            color: var(--text-light);
        }

        .item-detail {
            font-size: 0.9em; color: var(--text-light);
            margin-top: 0.25rem; padding-left: 0.5rem;
            font-weight: 400;
        }

        .photo-upload {
            border: 2px dashed var(--light-gold); border-radius: 12px;
            padding: 1.5rem; margin: 1.5rem 0; text-align: center;
        }

        .photo-upload h4 {
            color: var(--brand-green); margin-bottom: 0.5rem;
            font-size: 1.1em; font-weight: 700;
        }

        .photo-upload .photo-hint {
            font-size: 0.9em; color: var(--text-light);
            margin-bottom: 1rem;
        }
        
        input[type="file"] { display: none; }

        .photo-upload-btn {
            background-color: var(--brand-gold); color: var(--white);
            padding: 0.75rem 1.5rem; border-radius: 25px;
            cursor: pointer; display: inline-block; font-weight: 700;
            transition: all 0.3s ease; border: none;
        }
        .photo-upload-btn:hover {
            background-color: #a57c36; transform: translateY(-2px);
        }
        
        .photo-preview {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem; margin-top: 1rem;
        }

        .photo-preview-item {
            position: relative; border-radius: 8px;
            overflow: hidden; aspect-ratio: 1;
        }
        .photo-preview-item img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .photo-preview-item .remove-photo {
            position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white;
            border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
            font-size: 16px; display: flex; align-items: center; justify-content: center;
        }
        
        .navigation-buttons {
            display: flex; justify-content: space-between;
            padding: 1rem 1.5rem; border-top: 1px solid var(--border-color);
        }

        .nav-btn {
            background-color: var(--brand-green); color: var(--white);
            border: none; padding: 0.8rem 2rem;
            font-size: 1em; border-radius: 25px; cursor: pointer;
            transition: all 0.3s; font-weight: 700;
            font-family: 'Lato', sans-serif;
        }
        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 51, 43, 0.2);
        }
        .nav-btn:disabled {
            background-color: #ccc; cursor: not-allowed; opacity: 0.7;
        }
        
        #submitBtn { background-color: var(--brand-gold); }

        .submission-status {
            padding: 0 1.5rem 1rem; text-align: center;
        }
        .submit-message {
            padding: 1rem; border-radius: 8px; display: none;
        }
        .submit-message.success {
            background: #e6f1f0; color: var(--success); border: 1px solid var(--success); display: block;
        }
        .submit-message.error {
            background: #f8d7da; color: var(--error); border: 1px solid var(--error); display: block;
        }

        .footer {
            background-color: var(--brand-green); color: var(--light-gold); text-align: center;
            padding: 1.5rem; font-size: 1em;
        }
        .confidentiality-notice {
            margin-top: 0.5rem;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid var(--white);
            border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;
            display: inline-block; margin-left: 10px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 2rem; border-radius: 12px;
            border: 1px solid #ddd; width: 90%; max-width: 500px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 { font-size: 1.5em; color: var(--brand-green); margin-bottom: 1rem; }
        .modal-content p { margin-bottom: 1.5rem; color: var(--text-light); }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        .modal-btn { padding: 0.8rem 1.5rem; border-radius: 25px; border: none; font-weight: 700; cursor: pointer; }
        #modal-submit-anyway { background-color: var(--brand-gold); color: white; }
        #modal-go-back { background-color: #eee; color: var(--text-dark); }

        .workflow-diagram {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
             background-color: var(--background);
        }
        .workflow-diagram h3 {
             font-size: 1.1em; text-align: center;
             margin-bottom: 1rem; color: var(--brand-green);
        }
        .workflow-steps {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 0.5rem;
        }
        .workflow-step {
            text-align: center;
            font-size: 0.8em;
            color: var(--text-dark);
            font-weight: 700;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(234, 232, 226, 0.9);
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            backdrop-filter: blur(4px);
            flex-grow: 1;
            flex-basis: 0;
        }
         .workflow-step .emoji { font-size: 1.2em; }

        .workflow-arrow {
            color: var(--light-gold);
            font-size: 1.5em;
            font-weight: 700;
            flex-grow: 0;
        }

        @media screen and (max-width: 768px) {
            .main-container { margin: 0; border-radius: 0; }
            .header h1 { font-size: 2.5em; }
            .card { padding: 1rem; }
            .navigation-tabs { padding: 0.5rem 1rem; }
            .nav-tab .label { display: none; }
            .workflow-steps { flex-wrap: wrap; justify-content: center; }
            .workflow-step { font-size: 0.7em; flex-basis: 40%; margin-bottom: 0.5rem; }
            .workflow-arrow { display: none; }
            .workflow-arrow:nth-of-type(2) { display: block; margin: 0.5rem 0; transform: rotate(90deg); width: 100%; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="header">
            <h1>CASCADE HIDEAWAY</h1>
            <p class="subtitle">Deep Clean Checklist & Quality Report</p>
        </header>

        <form id="cleaningForm">
            <div class="progress-section">
                <div class="progress-label">
                    <span>Overall Progress</span>
                    <span class="percentage">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="checklist-body">
                <div class="navigation-tabs"></div>
                <div class="card-container"></div>
                <div class="submission-status">
                     <div id="submitMessage" class="submit-message"></div>
                </div>
                <div class="navigation-buttons">
                    <button type="button" class="nav-btn" id="prevBtn">Previous</button>
                    <button type="button" class="nav-btn" id="nextBtn">Next</button>
                </div>
            </div>
        </form>

        <footer class="footer">
            ‚ú® Calm ‚Ä¢ Clean ‚Ä¢ Consistent ‚Äî Every Stay ‚ú®
            <div class="confidentiality-notice">Confidential: For Internal Cascade Use Only.</div>
        </footer>
    </div>

    <!-- Submission Modal -->
    <div id="submissionModal" class="modal">
        <div class="modal-content">
            <h3>Incomplete Items Found</h3>
            <p id="modal-message">You have some unchecked items. Are you sure you want to submit the report as is?</p>
            <div class="modal-buttons">
                <button type="button" class="modal-btn" id="modal-go-back">Go Back & Review</button>
                <button type="button" class="modal-btn" id="modal-submit-anyway">Submit As-Is</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA STRUCTURE (Streamlined Checklist with Restored Details) ---
        const checklistData = [
            {
                title: "Prep & Inspection", icon: "üîç",
                description: "<strong>üéØ Goal:</strong> Gather everything you need BEFORE entering. Think of this like a chef preparing 'mise en place'‚Äîit saves 10-15 minutes per cleaning! <br><br> <strong>üéØ Why This Matters:</strong> Checking FIRST prevents cleaning over problems. Good ventilation and bright lights help you see every detail and make chemicals work better. Fresh air + bright light = better quality.",
                hasPhotos: true, photoTitle: "üì∏ Maintenance Issues or Lost & Found", photoHint: "Take clear photos of ANY damage or lost items. This protects you from blame and helps maintenance fix problems faster!",
                hasNotes: true, notesTitle: "üìù Issues Found & Lost Items:",
                items: [
                    { id: "check_0_1", text: "Gather all supplies, linens, and amenities", detail: "<strong>‚ö° Pro Tip:</strong> Use a cleaning caddy! ‚úì Supplies: All-purpose, bathroom, degreaser, glass cleaner. ‚úì Tools: 4+ microfiber cloths, vacuum, mop. ‚úì Linens: Full set for bed & bath. ‚úì Amenities: 2 3-in-1 coffee, 2 coffee sticks, 2 500ml water, 2 toiletry kits, tissues, paper towels." },
                    { id: "check_1_1", text: "Announce entry, open all windows and lights", detail: "Knock 3 times, announce 'Housekeeping'. Full ventilation and all lights on helps you see every detail and removes odors." },
                    { id: "check_1_4", text: "Test all electronics and fixtures", detail: "Check TV remote, Wi-Fi signal, AC cooling, and every single light switch. Report issues now so repairs can start while you clean." },
                    { id: "check_1_5", text: "Inspect for damages or leaks", detail: "Look for water stains under all sinks, faucets, toilet base, and AC unit. Check walls for cracks or stains and furniture for damage." },
                    { id: "check_1_7", text: "Conduct thorough lost & found search", detail: "Crucial spots: Drawers, under bed, behind doors, between mattress & headboard, and under cushions." },
                ]
            },
            {
                title: "Clear Out & Dwell Time", icon: "‚è≥",
                description: "<strong>üéØ Why Remove Everything First:</strong> Clearing trash and old linens first gives you clean, empty surfaces. Starting laundry NOW is called 'overlapping tasks'‚Äîlet the washer work while you work! <br><br> <strong>üß™ What is 'Dwell Time'?</strong> Letting cleaners sit on a surface breaks down grime automatically, meaning MUCH LESS scrubbing for you. <strong>‚ùå Common Mistake:</strong> Spraying and immediately wiping is why cleaning feels hard!",
                items: [
                    { id: "check_2_1", text: "Empty all trash bins and remove used items", detail: "Check bedroom, bathroom, kitchen, and balcony. Bag up all trash, food containers, and disposables immediately to prevent odors." },
                    { id: "check_2_4", text: "Strip all bed linens and bathroom towels", detail: "<strong>‚ö° Pro Strategy:</strong> Pre-treat any visible stains before washing. Start the laundry cycle now to overlap tasks and save time." },
                    { id: "check_3_1", text: "Apply cleaner to toilet bowl and shower/tub", detail: "Coat all surfaces generously‚Äîunder the rim, shower walls from top to bottom, tub, tiles, and grout. Don't scrub yet!" },
                    { id: "check_3_4", text: "Apply cleaner/degreaser to stovetop and microwave", detail: "Spray greasy surfaces like the stovetop, backsplash, and inside the microwave. Let it sit for 10-15 minutes to dissolve oil." }
                ]
            },
            {
                title: "Studio & Bedroom", icon: "üõèÔ∏è",
                description: "<strong>üéØ Why 'Top to Bottom'?</strong> Gravity is your friend! Dust high surfaces first so dust falls onto lower ones. This way, you only clean each surface ONCE. <br><br> <strong>üéØ Why 'Dry' First?</strong> Dust + water = mud! Always do dry dusting before any wet cleaning like mopping.",
                hasPhotos: true, photoTitle: "üì∏ Bed & Studio Photos *REQUIRED*", photoHint: "Take photos from the doorway angle to capture the guest's first view. Show the perfectly made bed.",
                items: [
                    { id: "check_4_1", text: "Dust all surfaces from top to bottom", detail: "Start with ceiling fixtures/fans, then picture frames, shelves, tables, and end with baseboards. Clean windows and sills." },
                    { id: "check_4_5", text: "Disinfect high-touch points", detail: "Use disinfectant on all light switches, TV remotes, thermostats, and door handles (both sides)." },
                    { id: "check_5_2", text: "Make the bed to hotel standard", detail: "Use tight, wrinkle-free sheets. Create crisp hospital corners at the foot of the bed for a professional look." },
                    { id: "check_5_6", text: "Fluff and arrange pillows symmetrically", detail: "Fluff pillows vigorously. A plump, perfectly arranged pillow signals luxury and comfort." },
                ]
            },
            {
                title: "Kitchen & Bathroom", icon: "üíß",
                description: "<strong>üéØ Zero-Tolerance Areas:</strong> Now that cleaners have dwelled, grime will lift easily. These rooms are where guests judge cleanliness most harshly. Every surface must be spotless and dry.",
                hasPhotos: true, photoTitle: "üì∏ Kitchen & Bathroom Photos *REQUIRED*", photoHint: "Capture the sparkling faucets, streak-free glass, and gleaming appliance surfaces.",
                items: [
                    { id: "check_7_4", text: "Scrub and disinfect toilet, shower, and sink", detail: "Use a dedicated cloth for the toilet. Scrub the shower/tub, then rinse thoroughly. Clean the sink basin and polish the faucet until it shines." },
                    { id: "check_7_2", text: "Clean all glass and mirrors to a streak-free shine", detail: "<strong>‚ö° The Squeegee Secret:</strong> After cleaning, use a squeegee to dry the shower glass completely. This prevents water spots and looks professional." },
                    { id: "check_6_1", text: "Wipe down all kitchen appliances, inside and out", detail: "Clean microwave interior (no oil/residue) with warm water & cleaner/degreaser. Wipe fridge, rice cooker, kettle, and polish the stovetop." },
                    { id: "check_6_4", text: "Clean and polish sink, faucet, and countertops", detail: "A gleaming faucet is a key sign of a detailed clean. Wipe all counters, including the kitchen island, edges, and backsplash." },
                    { id: "check_7_7", text: "Restock amenities & check liquid soaps", detail: "Fold towels in thirds. Restock disposables. Check levels and refill: hand soap, liquid bath soap, shampoo, and dishwashing liquid." },
                ]
            },
            {
                title: "Final Staging & QA", icon: "‚ú®",
                description: "<strong>üéØ The 'Wow' Moment:</strong> This is the final pass to transition the space from 'clean' to 'perfectly staged'. <br><br><strong>üéØ Floor Strategy:</strong> Always clean your way out of the unit ('Back to Exit') to avoid stepping on clean floors. Vacuum before mopping to prevent muddy streaks. Clean the bathroom floor LAST as it's the wettest area.",
                hasPhotos: true, photoTitle: "üì∏ Final Overview Photos *REQUIRED*", photoHint: "Show the complete transformation. These photos represent your commitment to quality.",
                hasNotes: true, notesTitle: "üìù Completion Summary & Notes",
                items: [
                    { id: "check_8_1", text: "Vacuum and mop all floors", detail: "Start from the furthest corner and work your way toward the exit so you don't step on clean floors." },
                    { id: "check_balcony", text: "Wipe down balcony table, chairs, and railing", detail: "Ensure the outdoor space is clean and inviting for guests." },
                    { id: "check_9_1", text: "Final fingerprint and dust check", detail: "<strong>‚ö° Guest Perspective:</strong> Re-enter the unit as if you were a guest. Wipe any smudges from glass, mirrors, chrome fixtures, and door handles." },
                    { id: "check_9_4", text: "Stage the room for guest arrival", detail: "Set AC to a comfortable **23¬∞C**, turn on soft ambient lighting (e.g., bedside lamps), and align all decor symmetrically." },
                    { id: "check_10_6", text: "Final security check", detail: "Ensure all cleaning supplies are removed, all windows are closed and locked, and the front door is securely locked upon exit." }
                ]
            }
        ];

        // --- GLOBAL STATE ---
        const allPhotos = {};
        let currentCardIndex = 0;

        // --- DOM ELEMENTS ---
        const cardContainer = document.querySelector('.card-container');
        const navTabsContainer = document.querySelector('.navigation-tabs');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submissionModal = document.getElementById('submissionModal');
        const submitMessageDiv = document.getElementById('submitMessage');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const initialCardData = { title: "Cleaner Info", icon: "üë§", isInfoCard: true };
            const allSections = [initialCardData, ...checklistData];

            generateHTML(allSections);
            setupEventListeners(allSections.length);
            showCard(0);
            updateProgress();
            loadDraft();
        });
        
        // --- HTML GENERATION ---
        function generateHTML(sections) {
            let cardsHTML = ''; let tabsHTML = '';
            sections.forEach((section, index) => {
                const sectionId = `section_${index}`;
                if (!section.isInfoCard) allPhotos[sectionId] = [];
                tabsHTML += `<div class="nav-tab" data-index="${index}"><span class="icon">${section.icon}</span><span class="label">${section.title}</span></div>`;
                cardsHTML += `<div class="card" id="${sectionId}" data-index="${index}">`;
                 if(section.isInfoCard) {
                    cardsHTML += `<h2>${section.icon} ${section.title}</h2>`;
                 } else {
                    cardsHTML += `<h2 style="font-family: 'Cormorant Garamond', serif; font-size: 2.2em;">${section.icon} ${section.title}</h2>`;
                 }

                if (section.isInfoCard) {
                    cardsHTML += `<div class="info-field-grid">
                        <div class="info-field"><label for="unitName">Unit Name</label><input type="text" id="unitName" name="unitName" value="Cascade Bria" readonly></div>
                        <div class="info-field"><label for="cleanerName">Cleaner Name *</label><input type="text" id="cleanerName" name="cleanerName" required placeholder="Your Full Name"></div>
                        <div class="info-field"><label for="startTime">Start Time *</label><input type="time" id="startTime" name="startTime" required></div>
                        <div class="info-field"><label for="endTime">End Time *</label><input type="time" id="endTime" name="endTime" required></div>
                    </div>
                    <div class="workflow-diagram">
                        <h3>General Workflow</h3>
                        <div class="workflow-steps">
                            <div class="workflow-step"><span class="emoji">üîç</span><br>Prep &<br>Inspect</div>
                            <div class="workflow-arrow">‚Üí</div>
                            <div class="workflow-step"><span class="emoji">‚è≥</span><br>Clear Out &<br>Dwell Time</div>
                            <div class="workflow-arrow">‚Üí</div>
                            <div class="workflow-step"><span class="emoji">üõèÔ∏è</span><br>Studio &<br>Bedroom</div>
                            <div class="workflow-arrow">‚Üí</div>
                            <div class="workflow-step"><span class="emoji">üíß</span><br>Kitchen &<br>Bathroom</div>
                             <div class="workflow-arrow">‚Üí</div>
                            <div class="workflow-step"><span class="emoji">‚ú®</span><br>Final Stage<br>& QA</div>
                        </div>
                    </div>`;
                } else {
                    if (section.description) cardsHTML += `<div class="section-description">${section.description}</div>`;
                    section.items.forEach(item => {
                        cardsHTML += `<div class="checklist-item">
                            <input type="checkbox" id="${item.id}" data-section-index="${index}">
                            <label for="${item.id}">${item.text}<div class="item-detail">${item.detail}</div></label>
                        </div>`;
                    });
                     if (section.hasPhotos || section.hasNotes) {
                        cardsHTML += '<div class="pro-tip">';
                        if (section.hasPhotos) cardsHTML += `<div class="photo-upload" style="border:none; padding:0;"><h4>${section.photoTitle}</h4><div class="photo-hint">${section.photoHint}</div><label for="photos_${sectionId}" class="photo-upload-btn">üì∑ Add Photos</label><input type="file" id="photos_${sectionId}" accept="image/*" multiple data-section-id="${sectionId}"><div id="preview_${sectionId}" class="photo-preview"></div></div>`;
                        if (section.hasNotes) cardsHTML += `<div class="notes-area" style="margin-top: 1.5rem;"><label style="font-weight: 700; font-size: 1.1em; color: var(--brand-green);">${section.notesTitle}</label><textarea id="notes_${sectionId}" name="notes_${sectionId}" placeholder="Example: Light switch in bathroom not working..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: 'Lato', sans-serif; min-height: 100px; margin-top: 0.5rem;"></textarea></div>`;
                        cardsHTML += '</div>';
                    }
                }
                cardsHTML += `</div>`;
            });
            cardContainer.innerHTML = cardsHTML;
            navTabsContainer.innerHTML = tabsHTML;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners(totalCards) {
            navTabsContainer.addEventListener('click', e => {
                if (e.target.closest('.nav-tab')) showCard(parseInt(e.target.closest('.nav-tab').dataset.index));
            });
            prevBtn.addEventListener('click', () => showCard(currentCardIndex - 1));
            nextBtn.addEventListener('click', () => (currentCardIndex === totalCards - 1) ? handleFormSubmit() : showCard(currentCardIndex + 1));
            
            document.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', saveDraft));
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', () => {
                updateProgress();
                updateSectionCompletionStatus(cb.dataset.sectionIndex);
                saveDraft();
            }));
            document.querySelectorAll('input[type="file"]').forEach(input => input.addEventListener('change', handlePhotoUpload));
            
            document.getElementById('modal-go-back').addEventListener('click', () => submissionModal.style.display = 'none');
            document.getElementById('modal-submit-anyway').addEventListener('click', () => {
                submissionModal.style.display = 'none';
                proceedWithSubmission();
            });
        }
        
        // --- CARD NAVIGATION & UI UPDATES ---
        function showCard(index) {
            const cards = document.querySelectorAll('.card'); const tabs = document.querySelectorAll('.nav-tab');
            if (index < 0 || index >= cards.length) return;
            currentCardIndex = index;
            
            cardContainer.style.height = (cardContainer.offsetHeight || 500) + 'px';
            
            cards.forEach((c, i) => c.classList.toggle('active', i === index));
            tabs.forEach((t, i) => t.classList.toggle('active', i === index));
            
            setTimeout(() => {
                if (cards[index]) {
                    cardContainer.style.height = cards[index].offsetHeight + 'px';
                }
            }, 50);

            prevBtn.disabled = index === 0;
            nextBtn.textContent = index === cards.length - 1 ? 'Submit Report' : 'Next';
            nextBtn.id = index === cards.length - 1 ? 'submitBtn' : 'nextBtn';
        }
        
        function updateProgress() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const checked = document.querySelectorAll('input[type="checkbox"]:checked');
            const percentage = checkboxes.length > 0 ? Math.round((checked.length / checkboxes.length) * 100) : 0;
            document.querySelector('.percentage').textContent = `${percentage}%`;
            document.querySelector('.progress-fill').style.width = `${percentage}%`;
            checkboxes.forEach(cb => cb.closest('.checklist-item').classList.toggle('checked', cb.checked));
        }
        
        function updateSectionCompletionStatus(sectionIndex) {
            const sectionCard = document.querySelector(`.card[data-index='${sectionIndex}']`);
            const navTab = document.querySelector(`.nav-tab[data-index='${sectionIndex}']`);
            if (!sectionCard || !navTab) return;
            const checkboxes = sectionCard.querySelectorAll('input[type="checkbox"]');
            if (checkboxes.length > 0) {
                navTab.classList.toggle('completed', Array.from(checkboxes).every(cb => cb.checked));
            }
        }

        // --- PHOTO HANDLING ---
        function handlePhotoUpload(event) {
            const input = event.target;
            const sectionId = input.dataset.sectionId;
            const previewContainer = document.getElementById(`preview_${sectionId}`);
            Array.from(input.files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) { alert(`File ${file.name} is too large (max 5MB).`); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoIndex = allPhotos[sectionId].push({ name: file.name, data: e.target.result }) - 1;
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview-item';
                    photoDiv.innerHTML = `<img src="${e.target.result}" alt="${file.name}"><button type="button" class="remove-photo" data-section-id="${sectionId}" data-photo-index="${photoIndex}">&times;</button>`;
                    previewContainer.appendChild(photoDiv);
                    photoDiv.querySelector('.remove-photo').addEventListener('click', (e) => {
                        allPhotos[e.target.dataset.sectionId][e.target.dataset.photoIndex] = null;
                        e.target.parentElement.remove();
                        saveDraft();
                    });
                    saveDraft();
                };
                reader.readAsDataURL(file);
            });
            input.value = '';
        }

        // --- AUTOSAVE / DRAFT HANDLING ---
        function saveDraft() {
            const formData = new FormData(document.getElementById('cleaningForm'));
            const data = Object.fromEntries(formData.entries());
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => data[cb.id] = cb.checked);
            localStorage.setItem('cleaningFormDraft', JSON.stringify({ data, photos: allPhotos }));
        }

        function loadDraft() {
            const draft = localStorage.getItem('cleaningFormDraft');
            if (draft) {
                if (confirm("Unsaved work found. Would you like to restore it?")) {
                    const { data, photos } = JSON.parse(draft);
                    for (const key in data) {
                        const el = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                        if (el) {
                            if (el.type === 'checkbox') el.checked = data[key];
                            else el.value = data[key];
                        }
                    }
                    Object.assign(allPhotos, photos);
                    for (const sectionId in allPhotos) {
                         const previewContainer = document.getElementById(`preview_${sectionId}`);
                         if(previewContainer) {
                            previewContainer.innerHTML = '';
                             allPhotos[sectionId].forEach((photoData, index) => {
                                 if (photoData) {
                                    const photoDiv = document.createElement('div');
                                    photoDiv.className = 'photo-preview-item';
                                    photoDiv.innerHTML = `<img src="${photoData.data}" alt="${photoData.name}"><button type="button" class="remove-photo" data-section-id="${sectionId}" data-photo-index="${index}">&times;</button>`;
                                    previewContainer.appendChild(photoDiv);
                                    photoDiv.querySelector('.remove-photo').addEventListener('click', (e) => {
                                        allPhotos[e.target.dataset.sectionId][e.target.dataset.photoIndex] = null;
                                        e.target.parentElement.remove();
                                        saveDraft();
                                    });
                                 }
                             });
                         }
                    }
                    updateProgress();
                    document.querySelectorAll('.nav-tab').forEach(t => updateSectionCompletionStatus(t.dataset.index));
                } else {
                    localStorage.removeItem('cleaningFormDraft');
                }
            }
            if (!document.getElementById('startTime').value) {
                const now = new Date();
                document.getElementById('startTime').value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            }
        }
        
        // --- SUBMISSION ---
        function handleFormSubmit() {
            const unchecked = document.querySelectorAll('input[type="checkbox"]:not(:checked)');
            if (unchecked.length > 0) {
                document.getElementById('modal-message').textContent = `You have ${unchecked.length} unchecked item(s). Submit anyway?`;
                submissionModal.style.display = 'flex';
            } else {
                proceedWithSubmission();
            }
        }

        async function proceedWithSubmission() {
            const submitBtn = document.getElementById('submitBtn') || document.getElementById('nextBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Submitting... <span class="loading-spinner"></span>';
            submitMessageDiv.style.display = 'none';

            const WEB3FORMS_ACCESS_KEY = '3c99bd93-612a-4a55-b367-64e744f9d9f2';
            
            const formData = new FormData(document.getElementById('cleaningForm'));
            const data = Object.fromEntries(formData.entries());
            data.checklist = {};
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => data.checklist[cb.id] = cb.checked);

            try {
                const response = await fetch("https://api.web3forms.com/submit", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Accept": "application/json" },
                    body: JSON.stringify({
                        access_key: WEB3FORMS_ACCESS_KEY,
                        subject: `Cleaning Report: ${data.unitName} by ${data.cleanerName}`,
                        to: "cascadereservations@gmail.com",
                        from_name: "Cascade Quality System",
                        html: generateEmailBody(data) // Use the 'html' property
                    })
                });
                const result = await response.json();
                if (result.success) {
                    submitMessageDiv.className = 'submit-message success';
                    submitMessageDiv.textContent = 'Report sent successfully!';
                    localStorage.removeItem('cleaningFormDraft');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                submitMessageDiv.className = 'submit-message error';
                submitMessageDiv.textContent = `Error: ${error.message}. Please try again.`;
            } finally {
                submitMessageDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Report';
            }
        }
        
        function generateEmailBody(data) {
            let detailsHTML = '';
            const allSections = [ {isInfoCard: true}, ...checklistData];

            allSections.forEach((section, index) => {
                if (section.isInfoCard) return;
                let checkedCount = 0;
                let itemsHTML = '<ul style="margin:0; padding-left: 20px;">';
                section.items.forEach(item => {
                    const isChecked = data.checklist[item.id];
                    if (isChecked) checkedCount++;
                    itemsHTML += `<li style="color:${isChecked ? 'green':'#aaa'};">${isChecked ? '‚úì' : '‚úó'} ${item.text}</li>`;
                });
                itemsHTML += '</ul>';

                const notes = data[`notes_section_${index}`] || '';
                const photoCount = allPhotos[`section_${index}`] ? allPhotos[`section_${index}`].filter(p=>p).length : 0;

                detailsHTML += `
                    <h3 style="margin-top:20px; margin-bottom:5px; color:#00332B;">${section.icon} ${section.title} (${checkedCount}/${section.items.length})</h3>
                    ${itemsHTML}
                    ${photoCount > 0 ? `<p style="margin:5px 0 0 20px; font-size:12px;"><em>${photoCount} photo(s) were uploaded for this section.</em></p>` : ''}
                    ${notes ? `<p style="margin:5px 0 0 20px; font-size:12px; white-space:pre-wrap;"><strong>Notes:</strong> ${notes}</p>` : ''}
                `;
            });
            const totalChecks = document.querySelectorAll('input[type="checkbox"]').length;
            const totalChecked = Object.values(data.checklist).filter(Boolean).length;
            const percentage = totalChecks > 0 ? Math.round((totalChecked / totalChecks) * 100) : 0;
            
            return `
                <div style="font-family: sans-serif; max-width: 600px; margin: auto; border: 1px solid #eee; padding: 20px;">
                    <h1 style="color: #00332B; text-align:center;">Cascade Cleaning Report</h1>
                    <table style="width:100%; margin-bottom:20px; border-collapse: collapse;">
                        <tr><td style="padding:8px; background:#f4f4f4; border:1px solid #ddd;"><strong>Unit:</strong></td><td style="padding:8px; border:1px solid #ddd;">${data.unitName}</td></tr>
                        <tr><td style="padding:8px; background:#f4f4f4; border:1px solid #ddd;"><strong>Cleaner:</strong></td><td style="padding:8px; border:1px solid #ddd;">${data.cleanerName}</td></tr>
                        <tr><td style="padding:8px; background:#f4f4f4; border:1px solid #ddd;"><strong>Time:</strong></td><td style="padding:8px; border:1px solid #ddd;">${data.startTime} - ${data.endTime}</td></tr>
                    </table>
                    <h2 style="color: #00332B; border-bottom: 2px solid #B48A3C; padding-bottom: 5px;">Overall Completion: ${percentage}%</h2>
                    ${detailsHTML}
                    <p style="text-align:center; margin-top:30px; font-size:12px; color:#999;">Confidential: For Internal Cascade Use Only.</p>
                </div>
            `;
        }
    </script>
</body>
</html>

